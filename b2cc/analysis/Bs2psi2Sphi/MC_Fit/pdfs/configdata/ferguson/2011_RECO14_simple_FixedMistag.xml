<RapidFit>

	//================================================
	// Formal Parameters to be fitted or fixed

	<ParameterSet>



		<PhysicsParameter>
			<Name>F_s</Name>
			<Value>0.067887</Value>
			<Minimum>0.</Minimum>
			<Maximum>0.5</Maximum>
			<Type>Free</Type>
			<Unit>Unitless</Unit>
		</PhysicsParameter>
		<PhysicsParameter>
			<Name>delta_s</Name>
			<Value>0.18</Value>
			<Minimum>-6.3</Minimum>
			<Maximum>6.3</Maximum>
			<Type>Free</Type>
			<Unit>Unitless</Unit>
		</PhysicsParameter>
		<PhysicsParameter>
			<Name>Csp</Name>
			<Value>1.0</Value>
			<Type>Fixed</Type>
			<Unit>Unitless</Unit>
		</PhysicsParameter>

		// True Physics Parameters for signal

		<PhysicsParameter>
			<Name>gamma</Name>
			<Value>0.6602</Value>
			<Minimum>0.6</Minimum>
			<Maximum>0.75</Maximum>
			<Type>Free</Type>
			<Unit>ps^{-1}</Unit>
		</PhysicsParameter>

		<PhysicsParameter>
			<Name>deltaGamma</Name>
			<Value>0.0805</Value>
			<Minimum>-0.2</Minimum>
			<Maximum>0.2</Maximum>
			<Type>Free</Type>
			<Unit>ps^{-1}</Unit>
			<BlindString>BsDGsNewDataPsi2s</BlindString>
			<BlindScale>0.02</BlindScale>
		</PhysicsParameter>

		<PhysicsParameter>
			<Name>Aperp_sq</Name>
			<Value>2.56236e-01</Value>
			<Minimum>0.</Minimum>
			<Maximum>0.5</Maximum>
			<Type>Free</Type>
			<Unit>Unitless</Unit>
		</PhysicsParameter>

		<PhysicsParameter>
			<Name>Azero_sq</Name>
			<Value>5.16612e-01</Value>
			<Type>Free</Type>
			<Minimum>0.</Minimum>
			<Maximum>0.8</Maximum>
			<Unit>Unitless</Unit>
		</PhysicsParameter>

		<PhysicsParameter>
			<Name>delta_para</Name>
			<Value>3.3</Value>
			<StepSize>0.05</StepSize>
			<Maximum>6.3</Maximum>
			<Minimum>-6.3</Minimum>
			<Type>Free</Type>
			<Unit>Unitless</Unit>
		</PhysicsParameter>

		<PhysicsParameter>
			<Name>delta_perp</Name>
			<Value>3.0e</Value>
			<Minimum>-6.3</Minimum>
			<Maximum>6.3</Maximum>
			<StepSize>0.05</StepSize>
			<Type>Free</Type>
			<Unit>Unitless</Unit>
		</PhysicsParameter>

		<PhysicsParameter>
			<Name>delta_zero</Name>
			<Value>0.0</Value>
			<Minimum>-3.3</Minimum>
			<Maximum>3.3</Maximum>
			<Type>Fixed</Type>
			<Unit>Unitless</Unit>
		</PhysicsParameter>

		<PhysicsParameter>
			<Name>deltaM</Name>
			<Value>1.77655e+01</Value>
			<Type>Free</Type>
			<Unit>ps-1</Unit>
		</PhysicsParameter>

		<PhysicsParameter>
			<Name>Phi_s</Name>
			<Value>-1.23e-01</Value>
			<Type>Free</Type>
			<Unit>Unitless</Unit>
			<BlindString>BsPhisNewDataPsi2S</BlindString>
			<BlindScale>0.2</BlindScale>
		</PhysicsParameter>

		<PhysicsParameter>
			<Name>lambda</Name>
			<Value>1.0</Value>
			<Type>Free</Type>
			<Unit>Unitless</Unit>
		</PhysicsParameter>

		//..................................
		// Detector Parameters

		// Resolution Model
		// Resolution Model
		<PhysicsParameter>
			<Name>timeResolutionScale</Name>
			#<Value>1.</Value>
			<Value>1.26195</Value>
			<Type>Fixed</Type>
			<Unit> </Unit>
		</PhysicsParameter>
		<PhysicsParameter>
			<Name>timeResolutionScale2</Name>
			<Value>1.90343</Value>
			<Type>Fixed</Type>
			<Unit> </Unit>
		</PhysicsParameter>
		<PhysicsParameter>
			<Name>timeResolutionOffset</Name>
			<Value>0.00341147</Value>
			<Type>Fixed</Type>
			<Unit> </Unit>
		</PhysicsParameter>
		<PhysicsParameter>
			<Name>timeResolutionOffset2</Name>
			<Value>0.0297015</Value>
			<Type>Fixed</Type>
			<Unit> </Unit>
		</PhysicsParameter>
		<PhysicsParameter>
			<Name>timeResFraction</Name>
			<Value>0.82089</Value>
			<Type>Fixed</Type>
			<Unit> </Unit>
		</PhysicsParameter>

		<PhysicsParameter>
			<Name>sfBarOffset_2011</Name>
			<Value>1.4207</Value>
			<Type>Fixed</Type>
			<Unit> </Unit>
		</PhysicsParameter>
		<PhysicsParameter>
			<Name>sfBarSlope_2011</Name>
			<Value>-2.85</Value>
			<Type>Fixed</Type>
			<Unit> </Unit>
		</PhysicsParameter>
		<PhysicsParameter>
			<Name>sfSigmaOffset_2011</Name>
			<Value>0.3778</Value>
			<Type>Fixed</Type>
			<Unit> </Unit>
		</PhysicsParameter>
		<PhysicsParameter>
			<Name>sfSigmaSlope_2011</Name>
			<Value>-1.55</Value>
			<Type>Fixed</Type>
			<Unit> </Unit>
		</PhysicsParameter>
		<PhysicsParameter>
			<Name>sigmaBar_2011</Name>
			<Value>0.0350</Value>
			<Type>Fixed</Type>
			<Unit> </Unit>
		</PhysicsParameter>
		<PhysicsParameter>
			<Name>timeResFraction_2011</Name>
			<Value>0.244</Value>
			<Type>Fixed</Type>
			<Unit> </Unit>
		</PhysicsParameter>
		<PhysicsParameter>
			<Name>timeResMu_2011</Name>
			<Value>-0.00255</Value>
			<Type>Fixed</Type>
		</PhysicsParameter>
		// Mistag parameters

		// Mistag calibration
		<PhysicsParameter>
			<Name>mistagP1_OS</Name>
			#<Value>0.</Value>
			<Value>0.982</Value>
			<Type>Fixed</Type>
			<Unit> </Unit>
		</PhysicsParameter>
		<PhysicsParameter>
			<Name>mistagP0_OS</Name>
			<Value>0.38084</Value>
			#<Value>0.3746</Value>
			<Type>Fixed</Type>
			<Unit> </Unit>
		</PhysicsParameter>
		<PhysicsParameter>
			<Name>mistagSetPoint_OS</Name>
			<Value>0.374641</Value>
			<Type>Fixed</Type>
			<Unit> </Unit>
		</PhysicsParameter>
		<PhysicsParameter>
			<Name>mistagDeltaP1_OS</Name>
			#<Value>0.0</Value>
			<Value>0.066</Value>
			<Type>Fixed</Type>
			<Unit> </Unit>
		</PhysicsParameter>
		<PhysicsParameter>
			<Name>mistagDeltaP0_OS</Name>
			#<Value>0.0</Value>
			<Value>0.014</Value>
			<Type>Fixed</Type>
			<Unit> </Unit>
		</PhysicsParameter>
		<PhysicsParameter>
			<Name>mistagDeltaSetPoint_OS</Name>
			<Value>0.0</Value>
			<Type>Fixed</Type>
			<Unit> </Unit>
		</PhysicsParameter>

		// Mistag calibration
		<PhysicsParameter>
			<Name>mistagP1_SS</Name>
			#<Value>0.</Value>
			<Value>0.976</Value>
			<Type>Fixed</Type>
			<Unit> </Unit>
		</PhysicsParameter>
		<PhysicsParameter>
			<Name>mistagP0_SS</Name>
			<Value>0.449999</Value>
			#<Value>0.4438</Value>
			<Type>Fixed</Type>
			<Unit> </Unit>
		</PhysicsParameter>
		<PhysicsParameter>
			<Name>mistagSetPoint_SS</Name>
			<Value>0.443795</Value>
			<Type>Fixed</Type>
			<Unit> </Unit>
		</PhysicsParameter>
		<PhysicsParameter>
			<Name>mistagDeltaP1_SS</Name>
			#<Value>0.0</Value>
			<Value>0.007</Value>
			<Type>Fixed</Type>
			<Unit> </Unit>
		</PhysicsParameter>
		<PhysicsParameter>
			<Name>mistagDeltaP0_SS</Name>
			#<Value>0.0</Value>
			<Value>-0.0158</Value>
			<Type>Fixed</Type>
			<Unit> </Unit>
		</PhysicsParameter>
		<PhysicsParameter>
			<Name>mistagDeltaSetPoint_SS</Name>
			<Value>0.0</Value>
			<Type>Fixed</Type>
			<Unit> </Unit>
		</PhysicsParameter>

		<PhysicsParameter>
			<Name>beta</Name>
			<Value>0.0</Value>
			<Unit> </Unit>
			<Type>Fixed</Type>
		</PhysicsParameter>

	</ParameterSet>


	//==========================================
	// Specify which minimiser to use.

	<Minimiser>
		<MinimiserName>Minuit</MinimiserName>
		<MaxSteps>100000</MaxSteps>
		<GradTolerance>0.01</GradTolerance>
		<Quality>0</Quality>
		#<ConfigureMinimiser>MinosErrors</ConfigureMinimiser>
		#<ConfigureMinimiser>NoHesse</ConfigureMinimiser>
	</Minimiser>

	<FitFunction>
		<WeightName>sWeight</WeightName>
		<FunctionName>NegativeLogLikelihoodThreaded</FunctionName>
		<Threads>16</Threads>
		<SetIntegratorTest>False</SetIntegratorTest>
		<NormaliseWeights>True</NormaliseWeights>
		<OffSetNLL>True</OffSetNLL>
	</FitFunction>

	<NumberRepeats>1</NumberRepeats>

	//==========================================
	// Specify the fit

	//...................................
	// This applies a constraint on deltaM
	<ToFit>
		<ConstraintFunction>
			<ExternalConstraint>
				<Name>deltaM</Name>
				<Value>17.768</Value>
				<Error>0.024</Error>
			</ExternalConstraint>
		</ConstraintFunction>
	</ToFit>

	// This applies a constraint on mistag scale
#	<ToFit>
#		<ConstraintFunction>
#		#	<ExternalConstraint>
#				<Name>mistagP1_OS</Name>
#				<Value>0.982</Value>
#				<Error>0.035</Error>
#			</ExternalConstraint>
#			<ExternalConstraint>
#				<Name>mistagP0_OS</Name>
#				<Value>0.0062</Value>
#				<Error>0.0044</Error>
#			</ExternalConstraint>
#			<ExternalConstraint>
#				<Name>mistagDeltaP0_OS</Name>
#				<Value>0.014</Value>
#				<Error>0.0012</Error>
#			</ExternalConstraint>
#			<ExternalConstraint>
#				<Name>mistagDeltaP1_OS</Name>
#				<Value>0.066</Value>
#				<Error>0.012</Error>
#			</ExternalConstraint>
#		</ConstraintFunction>
#	</ToFit>


#	<ToFit>
#		<ConstraintFunction>
#			<ExternalConstraint>
#				<Name>mistagP1_SS</Name>
#				<Value>0.976</Value>
#				<Error>0.18</Error>
#			</ExternalConstraint>
#			<ExternalConstraint>
#				<Name>mistagP0_SS</Name>
#				<Value>0.005</Value>
#				<Error>0.005</Error>
#			</ExternalConstraint>
#			<ExternalConstraint>
#				<Name>mistagDeltaP0_SS</Name>
#				<Value>-0.0158</Value>
#				<Error>0.0014</Error>
#			</ExternalConstraint>
#			<ExternalConstraint>
#				<Name>mistagDeltaP1_SS</Name>
#				<Value>0.007</Value>
#				<Error>0.0111</Error>
#			</ExternalConstraint>
#		</ConstraintFunction>
#	</ToFit>

	//===============================================================================================
	//===============================================================================================
	//===============================================================================================
	//===============================================================================================
	// The commonpdf and phase space to all segments

	<CommonPDF>
		<PDF>
			<Name>Bs2JpsiPhi_Signal_v7</Name>
			<ConfigurationParameter>UseHelicityBasis:True</ConfigurationParameter>
			<ConfigurationParameter>AngularAcceptanceFile:2014-3fbAnalysis/acceptance_weights_and_histos_2011_12102015.root</ConfigurationParameter>
			<ConfigurationParameter>AngularAcceptanceIgnoreNumerator:True</ConfigurationParameter>
			<ConfigurationParameter>UseTimeAcceptance:True</ConfigurationParameter>
			<ConfigurationParameter>UseEventResolution:True</ConfigurationParameter>
			<ConfigurationParameter>useNewMistagModel:True</ConfigurationParameter>
			#<ConfigurationParameter>ResolutionModel:ResolutionModel</ConfigurationParameter>
			<ConfigurationParameter>ResolutionModel:PerEventResModelDoubleWithOffset</ConfigurationParameter>
			#<ConfigurationParameter>ResolutionModel:Phis2012ResolutionModel</ConfigurationParameter>
			#<AppendParameterNames>sigmaBar:sfBarOffset:sfBarSlope:sfSigmaOffset:sfSigmaSlope:timeResFraction:timeResMu:beta:_2011</AppendParameterNames>
			<ConfigurationParameter>useMultiplePhis:False</ConfigurationParameter>
		</PDF>
	</CommonPDF>

	<CommonPhaseSpace>
		<PhaseSpaceBoundary>
			<Observable>
				<Name>time</Name>
				<Minimum>0.3</Minimum>
				<Maximum>14.0</Maximum>
				<Unit>ps</Unit>
			</Observable>
			<Observable>
				<Name>helcosthetaK</Name>
				<Minimum>-1.0</Minimum>
				<Maximum>1.0</Maximum>
				<Unit> </Unit>
			</Observable>
			<Observable>
				<Name>helphi</Name>
				<TF1>(helphi+TMath::Pi()-(helphi>0.)*(2.*TMath::Pi()))</TF1>
				<Minimum>-3.1416</Minimum>
				<Maximum>3.1416</Maximum>
				<Unit>rad</Unit>
			</Observable>
			<Observable>
				<Name>helcosthetaL</Name>
				<Minimum>-1.0</Minimum>
				<Maximum>1.0</Maximum>
				<Unit> </Unit>
			</Observable>
			<Observable>
				<Name>tagdecision_os</Name>
				<TF1>tagdecision_os_cb</TF1>
				<Value>1.</Value>
				<Value>0.</Value>
				<Value>-1.</Value>
				<Unit> </Unit>
			</Observable>
			<Observable>
				<Name>tagdecision_ss</Name>
				<TF1>tagdecision_ss_nn</TF1>
				<Value>1.</Value>
				<Value>0.</Value>
				<Value>-1.</Value>
				<Unit> </Unit>
			</Observable>
			<Observable>
				<Name>tagomega_os</Name>
				<TF1>tagomega_os_cb</TF1>
				<Minimum>0.</Minimum>
				<Maximum>0.5</Maximum>
				<Unit> </Unit>
			</Observable>
			<Observable>
				<Name>tagomega_ss</Name>
				<TF1>tagomega_ss_nn</TF1>
				<Minimum>0.</Minimum>
				<Maximum>0.5</Maximum>
				<Unit> </Unit>
			</Observable>
			<Observable>
				<Name>eventResolution</Name>
				#<TF1>0.045</TF1>
				<TF1>sigmat</TF1>
				<Minimum>0.0</Minimum>
				<Maximum>0.12</Maximum>
				<Unit> </Unit>
			</Observable>
			<Observable>
				<Name>sWeight</Name>
				<TF1>sweight_bs0</TF1>
				<Minimum>-100000</Minimum>
				<Maximum>100001</Maximum>
				<Unit> </Unit>
			</Observable>
			<Observable>
				<Name>unbiased</Name>
				<TF1>triggerDecisionUnbiased</TF1>
				<Value>0.0</Value>
				<Value>1.0</Value>
				<Unit> </Unit>
			</Observable>
			<Observable>
				<Name>biased</Name>
				<TF1>triggerDecisionBiasedExcl</TF1>
				<Value>0.0</Value>
				<Value>1.0</Value>
				<Unit> </Unit>
			</Observable>
		</PhaseSpaceBoundary>
	</CommonPhaseSpace>



	//===============================================================================================
	//===============================================================================================
	//===============================================================================================
	//===============================================================================================
	<ToFit>
		<CommonPDF>True</CommonPDF>
		<PDFConfigurator>
			<ConfigurationParameter>TimeAcceptanceFile:2014-3fbAnalysis/Bs_HltPropertimeAcceptance_Data_2011_40bins_Hlt1DiMuon_Hlt2DiMuonDetached_Reweighted_sel.txt</ConfigurationParameter>
		</PDFConfigurator>
		<DataSet>
			<Source>File</Source>
			<FileName>/afs/cern.ch/work/d/dferguso/psi2s_selection/2011_v2_final/2011_psi2s_sweighted.root</FileName>
			<CutString>triggerDecisionUnbiased==1</CutString>
			<NumberEvents>1000000000</NumberEvents>

			<CommonPhaseSpace>
			</CommonPhaseSpace>

		</DataSet>
	</ToFit>
	<ToFit>
		<CommonPDF>True</CommonPDF>
		<PDFConfigurator>
			<ConfigurationParameter>TimeAcceptanceFile:2014-3fbAnalysis/Bs_HltPropertimeAcceptance_Data_2011_40bins_Hlt1TrackAndTrackMuonExcl_Hlt2DiMuonDetached_sel.txt</ConfigurationParameter>
		</PDFConfigurator>
		<DataSet>
			<Source>File</Source>
			<FileName>/afs/cern.ch/work/d/dferguso/psi2s_selection/2011_v2_final/2011_psi2s_sweighted.root</FileName>
			<CutString>triggerDecisionBiasedExcl==1</CutString>
			<NumberEvents>1000000000</NumberEvents>

			<CommonPhaseSpace>
			</CommonPhaseSpace>

		</DataSet>
	</ToFit>

	<Output>
	#<Projection>time</Projection>
	#<Projection>helphi</Projection>
	#<Projection>helcosthetaK</Projection>
	#<Projection>helcosthetaL</Projection>
	<Scan>                                                                                                                                 
	<Name>Phi_s</Name>                                                                                                                     
	<Minimum>-1.0</Minimum>
	<Maximum>1.0</Maximum>
	<Points>20</Points>                                                                                                                   
	</Scan>
	</Output>

</RapidFit>


